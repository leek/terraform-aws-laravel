name: Announce Release

on:
  push:
    branches: [main]
    paths:
      - CHANGELOG.md
  workflow_dispatch:

permissions:
  contents: read

jobs:
  announce:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 2

      - name: Extract Latest Changelog
        id: changelog
        run: |
          # Skip Unreleased section and get the first real version section
          # Extract from first non-Unreleased ## [ until the next ---
          changelog=$(awk '
            /^## \[/ && !/Unreleased/ { flag=1 }
            flag { print }
            /^---$/ && flag { exit }
          ' CHANGELOG.md)

          # Extract version and date
          version=$(echo "$changelog" | grep -oP '## \[\K[^\]]+' | head -1)
          date=$(echo "$changelog" | grep -oP '\] - \K[0-9-]+' | head -1)

          # Extract sections - stop at "**Full Changelog**" or next section
          added=$(echo "$changelog" | awk '
            /^### Added$/ { flag=1; next }
            /^### / || /^\*\*Full/ { flag=0 }
            flag && /^- / { print }
          ' | sed 's/^- /‚Ä¢ /')

          changed=$(echo "$changelog" | awk '
            /^### Changed$/ { flag=1; next }
            /^### / || /^\*\*Full/ { flag=0 }
            flag && /^- / { print }
          ' | sed 's/^- /‚Ä¢ /')

          fixed=$(echo "$changelog" | awk '
            /^### Fixed$/ { flag=1; next }
            /^### / || /^\*\*Full/ { flag=0 }
            flag && /^- / { print }
          ' | sed 's/^- /‚Ä¢ /')

          removed=$(echo "$changelog" | awk '
            /^### Removed$/ { flag=1; next }
            /^### / || /^\*\*Full/ { flag=0 }
            flag && /^- / { print }
          ' | sed 's/^- /‚Ä¢ /')

          security=$(echo "$changelog" | awk '
            /^### Security$/ { flag=1; next }
            /^### / || /^\*\*Full/ { flag=0 }
            flag && /^- / { print }
          ' | sed 's/^- /‚Ä¢ /')

          echo "version=$version" >> $GITHUB_OUTPUT
          echo "date=$date" >> $GITHUB_OUTPUT
          echo "added<<EOF" >> $GITHUB_OUTPUT
          echo "$added" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "changed<<EOF" >> $GITHUB_OUTPUT
          echo "$changed" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "fixed<<EOF" >> $GITHUB_OUTPUT
          echo "$fixed" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "removed<<EOF" >> $GITHUB_OUTPUT
          echo "$removed" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "security<<EOF" >> $GITHUB_OUTPUT
          echo "$security" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Extract the full changelog URL if it exists
          full_changelog_url=$(echo "$changelog" | grep -oP '\*\*Full Changelog\*\*: \Khttps://[^\s]+' || echo "https://github.com/${{ github.repository }}/releases/tag/$version")
          echo "full_changelog_url=$full_changelog_url" >> $GITHUB_OUTPUT

      - name: Announce Release to Teams via Power Automate
        if: steps.changelog.outputs.version != ''
        run: |
          # Build body array with dynamic sections using jq
          # Split each section into individual TextBlocks for proper line breaks
          # Properly JSON-encode multiline strings to avoid shell/jq parsing issues
          ADDED_JSON=$(echo '${{ steps.changelog.outputs.added }}' | jq -Rs .)
          CHANGED_JSON=$(echo '${{ steps.changelog.outputs.changed }}' | jq -Rs .)
          FIXED_JSON=$(echo '${{ steps.changelog.outputs.fixed }}' | jq -Rs .)
          REMOVED_JSON=$(echo '${{ steps.changelog.outputs.removed }}' | jq -Rs .)
          SECURITY_JSON=$(echo '${{ steps.changelog.outputs.security }}' | jq -Rs .)

          body=$(jq -n \
            --arg version "${{ steps.changelog.outputs.version }}" \
            --arg date "${{ steps.changelog.outputs.date }}" \
            --arg actor "${{ github.actor }}" \
            --argjson added "$ADDED_JSON" \
            --argjson changed "$CHANGED_JSON" \
            --argjson fixed "$FIXED_JSON" \
            --argjson removed "$REMOVED_JSON" \
            --argjson security "$SECURITY_JSON" \
            '
            [
              {
                type: "TextBlock",
                text: ("üöÄ Apollo " + $version + " Released"),
                size: "Large",
                weight: "Bolder",
                color: "Accent"
              },
              {
                type: "TextBlock",
                text: ("Released on " + $date + " by " + $actor),
                isSubtle: true,
                spacing: "None"
              }
            ] +
            (if $added != "" then
              [{ type: "TextBlock", text: "**‚ú® Added**", weight: "Bolder", spacing: "Medium" }] +
              ($added | split("\n") | map(select(. != "") | { type: "TextBlock", text: ., wrap: true, spacing: "Small" }))
            else [] end) +
            (if $changed != "" then
              [{ type: "TextBlock", text: "**üîÑ Changed**", weight: "Bolder", spacing: "Medium" }] +
              ($changed | split("\n") | map(select(. != "") | { type: "TextBlock", text: ., wrap: true, spacing: "Small" }))
            else [] end) +
            (if $fixed != "" then
              [{ type: "TextBlock", text: "**üêõ Fixed**", weight: "Bolder", spacing: "Medium" }] +
              ($fixed | split("\n") | map(select(. != "") | { type: "TextBlock", text: ., wrap: true, spacing: "Small" }))
            else [] end) +
            (if $removed != "" then
              [{ type: "TextBlock", text: "**üóëÔ∏è Removed**", weight: "Bolder", spacing: "Medium" }] +
              ($removed | split("\n") | map(select(. != "") | { type: "TextBlock", text: ., wrap: true, spacing: "Small" }))
            else [] end) +
            (if $security != "" then
              [{ type: "TextBlock", text: "**üîí Security**", weight: "Bolder", spacing: "Medium" }] +
              ($security | split("\n") | map(select(. != "") | { type: "TextBlock", text: ., wrap: true, spacing: "Small" }))
            else [] end)
          ')

          # Build full Adaptive Card payload
          payload=$(jq -n \
            --argjson body "$body" \
            --arg releaseUrl "https://github.com/${{ github.repository }}/releases/tag/${{ steps.changelog.outputs.version }}" \
            --arg changelogUrl "https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md" \
            --arg fullChangelogUrl "${{ steps.changelog.outputs.full_changelog_url }}" \
            '{
              attachments: [
                {
                  contentType: "application/vnd.microsoft.card.adaptive",
                  content: {
                    "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                    type: "AdaptiveCard",
                    version: "1.4",
                    body: $body,
                    actions: [
                      {
                        type: "Action.OpenUrl",
                        title: "View Release",
                        url: $releaseUrl
                      },
                      {
                        type: "Action.OpenUrl",
                        title: "Full Changelog",
                        url: $fullChangelogUrl
                      },
                      {
                        type: "Action.OpenUrl",
                        title: "Changelog File",
                        url: $changelogUrl
                      }
                    ]
                  }
                }
              ]
            }')

          # Send to Power Automate webhook
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$payload" \
            'https://default2658679ca0e84be685d470758eb11b.ec.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/5c54691b4d2b4cb5b024078ba6844acf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=L42Uy_Tik-w2WK373FX5AawijJbMtK2OY2D8WQ2_qvM'
